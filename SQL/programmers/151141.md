# 자동차 대여 기록 별 대여 금액 구하기

```mysql
WITH DISCOUNT_RATES AS (
    SELECT
        DURATION_TYPE,
        CAST(REPLACE(DISCOUNT_RATE, '%', '') AS SIGNED)/100 AS RATE
    FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN
    WHERE CAR_TYPE = '트럭'
)

SELECT
    A.HISTORY_ID,
    CASE
        WHEN DATEDIFF(A.END_DATE, A.START_DATE)+1 >= 90
            THEN ROUND((DATEDIFF(A.END_DATE, A.START_DATE)+1)*B.DAILY_FEE*(1-(
                SELECT RATE FROM DISCOUNT_RATES WHERE DURATION_TYPE = '90일 이상'
            )), 0)
        WHEN DATEDIFF(A.END_DATE, A.START_DATE)+1 >= 30
            THEN ROUND((DATEDIFF(A.END_DATE, A.START_DATE)+1)*B.DAILY_FEE*(1-(
                SELECT RATE FROM DISCOUNT_RATES WHERE DURATION_TYPE = '30일 이상'
            )), 0)
        WHEN DATEDIFF(A.END_DATE, A.START_DATE)+1 >= 7
            THEN ROUND((DATEDIFF(A.END_DATE, A.START_DATE)+1)*B.DAILY_FEE*(1-(
                SELECT RATE FROM DISCOUNT_RATES WHERE DURATION_TYPE = '7일 이상'
            )), 0)
        ELSE (DATEDIFF(A.END_DATE, A.START_DATE)+1)*B.DAILY_FEE
    END AS FEE
FROM
    CAR_RENTAL_COMPANY_RENTAL_HISTORY A
    INNER JOIN (
        SELECT
            *
        FROM CAR_RENTAL_COMPANY_CAR
        WHERE CAR_TYPE = '트럭'
    ) B ON A.CAR_ID = B.CAR_ID
ORDER BY FEE DESC, A.HISTORY_ID DESC;
```

